---
import Layout from "../layouts/Layout.astro";
import { getCollection } from "astro:content";
import sections from "../content/guides/_sections.json";

interface GalleryImage {
  src: string;
  alt: string;
  caption: string;
  guideTitle: string;
  guideLink: string;
  section: string;
  context?: string;
}

// Get all guides
const allGuides = await getCollection("guides");

const images: GalleryImage[] = [];

// Regular expression to match markdown images: ![alt text](image-path)
const imageRegex = /!\[([^\]]*)\]\(([^)]+)\)/g;

// Regular expression to match headings before images (for context)
const headingRegex = /^#{1,6}\s+(.+)$/gm;

for (const guide of allGuides) {
  // Skip index pages
  if (guide.slug.endsWith("/index") || !guide.slug.includes("/")) {
    continue;
  }

  const guideLink = `/guide/${guide.slug}`;
  const guideTitle = guide.data.title;
  const sectionSlug = guide.slug.split("/")[0];
  const sectionData = sections[sectionSlug as keyof typeof sections];
  const sectionLabel = sectionData?.label || sectionSlug;

  // Get the raw markdown body
  const body = guide.body;

  // Extract all headings with their positions
  const headings: { text: string; position: number }[] = [];
  let headingMatch;
  while ((headingMatch = headingRegex.exec(body)) !== null) {
    headings.push({
      text: headingMatch[1],
      position: headingMatch.index,
    });
  }

  // Extract all images
  let match;
  while ((match = imageRegex.exec(body)) !== null) {
    const alt = match[1];
    const src = match[2];
    const imagePosition = match.index;

    // Find the closest heading before this image
    let closestHeading = "";
    for (let i = headings.length - 1; i >= 0; i--) {
      if (headings[i].position < imagePosition) {
        closestHeading = headings[i].text;
        break;
      }
    }

    // Create caption: use alt text if available, otherwise use article title
    let caption = alt || guideTitle;

    // Add context if we found a heading
    let context = closestHeading ? `${closestHeading}` : undefined;

    images.push({
      src,
      alt: alt || guideTitle,
      caption,
      guideTitle,
      guideLink,
      section: sectionLabel,
      context,
    });
  }
}

// Group images by section
const imagesBySection = images.reduce(
  (acc, img) => {
    if (!acc[img.section]) {
      acc[img.section] = [];
    }
    acc[img.section].push(img);
    return acc;
  },
  {} as Record<string, GalleryImage[]>,
);
---

<Layout
  title="Gallery - Surf Deeper"
  description="Visual guide to surfing concepts, wave types, and techniques. Explore diagrams and illustrations for better understanding."
  fullWidth={true}
>
  <div class="gallery-container">
    <header class="gallery-header">
      <h1>Gallery</h1>
      <p class="gallery-intro">
        All images from the surf guides in one place. Click any image to jump to
        the full guide where it appears.
        {
          images.length > 0 && (
            <span class="total-count">
              {" "}
              â€” {images.length} total image{images.length !== 1 ? "s" : ""}
            </span>
          )
        }
      </p>
    </header>

    {
      images.length === 0 ? (
        <div class="no-images">
          <p>
            No images found in the guides yet.{" "}
            <a href="/contribute">Contribute</a> guides with images!
          </p>
        </div>
      ) : (
        Object.entries(imagesBySection)
          .sort(([, a], [, b]) => b.length - a.length) // Sort by number of images descending
          .map(([section, sectionImages]) => (
            <section class="gallery-category">
              <h2 class="category-title">
                {section}{" "}
                <span class="image-count">({sectionImages.length})</span>
              </h2>
              <div class="gallery-grid">
                {sectionImages.map((image, idx) => (
                  <article class="card">
                    <a href={image.guideLink} class="gallery-link">
                      <img
                        src={image.src}
                        alt={image.alt}
                        loading="lazy"
                        class="gallery-image"
                      />
                      <div class="image-details">
                        <div class="image-caption">
                          {image.context && (
                            <div class="image-context">{image.context}</div>
                          )}
                          <div class="image-title">{image.caption}</div>
                        </div>
                        <div class="image-meta">
                          <span class="guide-reference">
                            from: {image.guideTitle}
                          </span>
                        </div>
                        <span class="view-guide-hint">View Guide â†’</span>
                      </div>
                    </a>
                  </article>
                ))}
              </div>
            </section>
          ))
      )
    }

    <section class="contribute-section">
      <div class="contribute-box">
        <h3>ðŸ“¸ Add Your Own</h3>
        <p>
          Have diagrams, illustrations, or photos that could help other surfers?
          <a href="/contribute">Contribute to the gallery</a> and share your knowledge
          with the community.
        </p>
      </div>
    </section>
  </div>
</Layout>

<style>
  .gallery-container {
    margin: 0 auto;
  }

  .gallery-header {
    text-align: center;
    margin-bottom: var(--space-2xl);
    padding-bottom: var(--space-lg);
    border-bottom: 2px solid var(--color-accent);
  }

  .gallery-header h1 {
    color: var(--color-accent);
    font-size: var(--font-size-3xl);
    margin: 0 0 var(--space-sm) 0;
    font-weight: var(--font-weight-bold);
  }

  .gallery-intro {
    color: var(--color-text-secondary);
    opacity: 0.9;
    font-size: var(--font-size-lg);
    line-height: var(--line-height-relaxed);
    max-width: 700px;
    margin: 0 auto;
  }

  .total-count {
    opacity: 0.7;
    font-size: var(--font-size-0-95);
  }

  .no-images {
    text-align: center;
    padding: var(--space-2xl) var(--space-sm);
    color: var(--color-text-secondary);
    opacity: 0.8;
    font-size: var(--font-size-lg);
  }

  .gallery-category {
    margin-bottom: var(--space-3xl);
  }

  .category-title {
    color: var(--color-accent);
    font-size: var(--font-size-2xl);
    margin: 0 0 var(--space-md) 0;
    font-weight: var(--font-weight-semibold);
    padding-left: var(--space-sm);
    border-left: 4px solid var(--color-accent);
    display: flex;
    align-items: center;
    gap: var(--space-sm);
  }

  .image-count {
    font-size: var(--font-size-base);
    opacity: 0.6;
    font-weight: 400;
  }

  .gallery-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: var(--space-lg);
    margin-bottom: var(--space-lg);
  }

  @media (max-width: 768px) {
    .gallery-grid {
      grid-template-columns: 1fr;
      gap: var(--space-md);
    }
  }

  .gallery-link {
    text-decoration: none;
    display: flex;
    flex-direction: column;
    height: 100%;
  }

  .gallery-grid .card {
    overflow: hidden;
    display: flex;
    flex-direction: column;
    padding: 0; /* media card: image edge-to-edge */
  }

  .gallery-image {
    width: 100%;
    height: 250px;
    object-fit: contain;
    display: block;
    padding: var(--space-sm);
  }

  .image-details {
    padding: var(--space-md);
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
  }

  .image-caption {
    display: flex;
    flex-direction: column;
    gap: var(--space-xs);
  }

  .image-context {
    color: var(--color-accent);
    font-size: var(--font-size-xs);
    opacity: 0.6;
    font-weight: var(--font-weight-medium);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .image-title {
    color: var(--color-accent);
    font-size: var(--font-size-lg);
    margin: 0;
    font-weight: var(--font-weight-semibold);
    line-height: var(--line-height-tight);
  }

  .image-meta {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .guide-reference {
    color: var(--color-text-secondary);
    opacity: 0.7;
    font-size: var(--font-size-sm);
    font-style: italic;
  }

  .view-guide-hint {
    color: var(--color-accent);
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-semibold);
    display: inline-flex;
    align-items: center;
    gap: var(--space-xs);
    opacity: 0.7;
    transition: opacity 0.3s ease;
    margin-top: auto;
  }

  .gallery-grid .card:hover .view-guide-hint {
    opacity: 1;
  }

  .contribute-section {
    margin-top: var(--space-3xl);
    padding-top: var(--space-2xl);
    border-top: 2px solid var(--color-accent);
  }

  .contribute-box {
    /* use card styles */
    background-color: var(--color-surface-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--border-radius-lg);
    padding: var(--space-lg);
    text-align: center;
    max-width: 700px;
    margin: 0 auto;
    box-shadow: var(--shadow-base);
  }

  .contribute-box h3 {
    color: var(--color-accent);
    font-size: var(--font-size-2xl);
    margin: 0 0 var(--space-sm) 0;
    font-weight: var(--font-weight-semibold);
  }

  .contribute-box p {
    color: var(--color-text-secondary);
    opacity: 0.9;
    font-size: var(--font-size-lg);
    line-height: var(--line-height-relaxed);
    margin: 0;
  }

  .contribute-box a:hover {
    opacity: 0.8;
  }

  @media (max-width: 768px) {
    .gallery-header h1 {
      font-size: var(--font-size-2xl);
    }

    .gallery-intro {
      font-size: var(--font-size-base);
    }

    .category-title {
      font-size: var(--font-size-xl);
    }

    .contribute-box {
      padding: var(--space-md);
    }
  }
</style>
