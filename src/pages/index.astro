---
import Layout from "../layouts/Layout.astro";
import LeftSidebar from "../components/sidebar/LeftSidebar.astro";
import RightSidebar from "../components/sidebar/RightSidebar.astro";
import { loadHomepageData } from "../utils/homepage-data";

const {
  spots,
  guidesBySection,
  comingSoonCountBySection,
  recentCommits,
  recentlyUpdated,
} = await loadHomepageData();
---

<Layout
  title="Surf Deeper"
  description="Open source surfing guide for skills and spots. Community-driven knowledge for surfers of all levels."
>
  <div class="homepage-wrapper">
    <div class="marquee-container">
      <div class="marquee" id="surf-ticker">
        <span id="ticker-content">Loading surf conditions...</span>
      </div>
    </div>

    <div class="three-column-layout">
      <!-- Main Content -->
      <section class="content">
        <div class="main-content-grid">
          <div class="map-preview-section">
            <div id="map-preview" class="map-preview-container">
              <div
                id="spot-list-panel-homepage"
                class="spot-list-panel-homepage"
              >
                <h3>Spots on Map</h3>
                <ul id="spot-list-homepage"></ul>
              </div>
            </div>
          </div>
        </div>

        {/** Mobile-only quick sections below the map */}
        <div class="mobile-home-sections">
          <div class="card">
            <h3>üèÑ Explore the Skills Guide</h3>
            <p class="about-text">
              Learn fundamentals, techniques, and strategy. Short, practical
              guides for all levels.
            </p>
            <div class="sidebar-cta-wrap">
              <a href="/guide" class="btn btn-primary">Browse Guide ‚Üí</a>
            </div>
          </div>

          <div class="card">
            <h3>üí° About</h3>
            <p class="about-text">
              <strong>Free and open source</strong> ‚Äî Built by surfers, for surfers.
              Share your knowledge and help the community grow.
            </p>
            <div class="sidebar-cta-wrap">
              <a href="/contribute" class="btn btn-secondary">Contribute</a>
            </div>
          </div>

          {
            recentlyUpdated.length > 0 && (
              <div class="card updates-section">
                <h3>üìù Recently Updated</h3>
                <ul class="updates-list">
                  {recentlyUpdated.slice(0, 3).map((page) => (
                    <li class="update-item">
                      <a href={page.url} class="update-link">
                        <span class="page-hierarchy">{page.hierarchy}</span>
                        <span class="page-title">{page.title}</span>
                      </a>
                      <span class="update-date">
                        {new Date(page.date).toLocaleString("en-US", {
                          timeZone: "America/Los_Angeles",
                          month: "short",
                          day: "numeric",
                          year: "numeric",
                        })}
                      </span>
                    </li>
                  ))}
                </ul>
              </div>
            )
          }
        </div>
      </section>

      <!-- Left Sidebar -->
      <LeftSidebar
        guidesBySection={guidesBySection}
        comingSoonCountBySection={comingSoonCountBySection}
      />

      <!-- Right Sidebar -->
      <RightSidebar
        recentlyUpdated={recentlyUpdated}
        recentCommits={recentCommits}
      />
    </div>
  </div>
</Layout>

<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  crossorigin=""
/>
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  crossorigin=""
  defer></script>

<style>
  @import "../styles/homepage.css";
</style>

<script
  type="application/json"
  id="spots-data"
  set:html={JSON.stringify(
    spots.map((s) => ({
      title: s.data.title,
      description: s.data.description || "",
      latitude: s.data.latitude,
      longitude: s.data.longitude,
      slug: s.slug,
    })),
  )}
/>

<script>
  import { initializeMapPreview } from "../scripts/map-preview";

  // Initialize map preview
  initializeMapPreview();
</script>

<script>
  import { updateSurfTicker } from "../scripts/surf-ticker";

  // Initialize surf ticker
  if (
    document.readyState === "complete" ||
    document.readyState === "interactive"
  ) {
    updateSurfTicker();
  } else {
    document.addEventListener("DOMContentLoaded", updateSurfTicker);
  }

  // Refresh every 15 minutes
  setInterval(updateSurfTicker, 15 * 60 * 1000);
</script>
