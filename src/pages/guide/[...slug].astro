---
import Layout from "../../layouts/Layout.astro";
import { getCollection, getEntryBySlug } from "astro:content";
import { isPlaceholderTodo } from "../../utils/guide-filters";

export async function getStaticPaths() {
  const entries = await getCollection("guides");
  return entries.map((e) => ({ params: { slug: e.slug } }));
}

const { slug } = Astro.params;
const slugStr = String(slug);
let entry = await getEntryBySlug("guides", slugStr);

// If direct slug not found, try section/index pattern
if (!entry && !slugStr.includes("/")) {
  entry = await getEntryBySlug("guides", `${slugStr}/index`);
}

if (!entry) {
  throw Astro.redirect("/guide");
}

const { Content } = await entry.render();
const { data } = entry;

// Check if this is a section landing page
// Astro normalizes folder/index.md to just folder as the slug
const isSectionPage =
  entry.slug.endsWith("/index") || !entry.slug.includes("/");
let sectionGuides: any[] = [];

if (isSectionPage) {
  // Get all guides in this section
  const allGuides = await getCollection("guides");
  const sectionName = entry.slug.replace("/index", "");
  sectionGuides = allGuides
    .filter((guide) => {
      const guideSection = guide.slug.split("/")[0];
      // Include guides in this section, but exclude the index page itself
      return (
        guideSection === sectionName &&
        guide.slug !== entry.slug &&
        guide.slug.includes("/")
      );
    })
    .sort(
      (a, b) =>
        (a.data.order ?? 999) - (b.data.order ?? 999) ||
        a.data.title.localeCompare(b.data.title),
    );
}
---

<Layout
  title={data.title}
  description={data.description}
  editPath={`src/content/guides/${entry.slug}.md`}
>
  <article class="guide-article">
    <Content />

    {
      isSectionPage && sectionGuides.length > 0 && (
        <section class="section-guides">
          <h2>Guides in this section</h2>
          <ul class="guides-list">
            {sectionGuides.map((guide) => {
              const disabled = isPlaceholderTodo(guide.body);
              return (
                <li>
                  <a
                    class={disabled ? "is-disabled" : undefined}
                    href={!disabled ? `/guide/${guide.slug}` : "#"}
                    aria-disabled={disabled ? "true" : undefined}
                    tabindex={disabled ? -1 : undefined}
                  >
                    {guide.data.title}
                  </a>
                  {disabled ? (
                    <p class="guide-description">coming soon</p>
                  ) : (
                    guide.data.description && (
                      <p class="guide-description">{guide.data.description}</p>
                    )
                  )}
                </li>
              );
            })}
          </ul>
        </section>
      )
    }
  </article>

  <style>
    .guide-article {
      max-width: 800px;
      margin: 0 auto;
    }

    .guide-article :global(img) {
      max-width: 100%;
      height: auto;
      display: block;
      margin: 1.5rem auto;
    }

    .section-guides {
      margin-top: var(--space-12);
      padding-top: var(--space-8);
      border-top: 2px solid var(--color-border);
    }

    .section-guides h2 {
      color: var(--color-accent);
      font-size: var(--font-size-3xl);
      margin-bottom: var(--space-6);
      text-align: center;
    }

    .guides-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .guides-list li {
      margin-bottom: var(--space-6);
      padding-left: var(--space-6);
      position: relative;
    }

    .guides-list li::before {
      content: "â€¢";
      position: absolute;
      left: 0;
      color: var(--color-accent);
      font-weight: bold;
      font-size: var(--font-size-lg);
    }

    .guides-list li a {
      color: var(--color-accent);
      text-decoration: underline;
      text-decoration-color: var(--color-accent);
      text-underline-offset: 3px;
      transition: color var(--transition-base);
      font-size: var(--font-size-lg);
      font-weight: var(--font-weight-semibold);
    }

    .guides-list li a:hover {
      color: var(--color-accent-hover);
      text-decoration-color: var(--color-accent);
    }

    .guides-list li a.is-disabled {
      pointer-events: none;
      opacity: 0.6;
      text-decoration: none;
      cursor: default;
    }

    .guide-description {
      color: var(--color-text-primary);
      opacity: 0.9;
      margin: var(--space-2) 0 0 0;
      line-height: var(--line-height-relaxed);
      font-size: var(--font-size-sm);
    }
  </style>
</Layout>
